@testitem "Form factors" begin
    # Compute form factors for all ion types, and on arbitrary arguments

    q2 = 0.57
    g_lande = 2.15

    brown_keys = ["Sc0", "Sc1", "Sc2", "Ti0", "Ti1", "Ti2", "Ti3", "V0", "V1", "V2", "V3", "V4", "Cr0", "Cr1", "Cr2", "Cr3", "Cr4", "Mn0", "Mn1", "Mn2", "Mn3", "Mn4", "Mn5", "Fe0", "Fe1", "Fe2", "Fe3", "Fe4", "Co0", "Co1", "Co2", "Co3", "Co4", "Ni0", "Ni1", "Ni2", "Ni3", "Ni4", "Cu0", "Cu1", "Cu2", "Cu3", "Cu4", "Y0", "Zr0", "Zr1", "Nb0", "Nb1", "Mo0", "Mo1", "Tc0", "Tc1", "Ru0", "Ru1", "Rh0", "Rh1", "Pd0", "Pd1", "Ce2", "Nd2", "Nd3", "Sm2", "Sm3", "Eu2", "Eu3", "Gd2", "Gd3", "Tb2", "Tb3", "Dy2", "Dy3", "Ho2", "Ho3", "Er2", "Er3", "Tm2", "Tm3", "Yb2", "Yb3", "Pr3", "U3", "U4", "U5", "Np3", "Np4", "Np5", "Np6", "Pu3", "Pu4", "Pu5", "Pu6", "Am2", "Am3", "Am4", "Am5", "Am6", "Am7", "Ce3"]
    brown_refs = [0.8612304997894441, 0.8881300904340745, 0.9230918862523916, 0.923467579984288, 0.9139840048505373, 0.9372367736681745, 0.9496672486192593, 0.9387414436352444, 0.9296780689558954, 0.9466896598740736, 0.9567365809554337, 0.9630889096843591, 0.9435941305046178, 0.9406231660592046, 0.9537320763330333, 0.9618915054196684, 0.9675316114002389, 0.9546973880547955, 0.9474245296765115, 0.9592875197450461, 0.9656789198525291, 0.9705818851479407, 0.9748399613636751, 0.9596325798238697, 0.9535707956813343, 0.963008881420943, 0.969332007705793, 0.9730528909464593, 0.963233554128305, 0.958147661850175, 0.9662171638122391, 0.9717639318914623, 0.9758919894599727, 0.9732576975562593, 0.9623747292536808, 0.9693692337032696, 0.9742397060244375, 0.9773755323244421, 0.9648586405606043, 0.9664889420493662, 0.9719718550880967, 0.975904640706173, 0.9789175124873787, 0.8271642655429379, 0.8661713785257669, 0.8595231612899285, 0.8892116937907717, 0.8811771880487423, 0.9166729281833833, 0.8990961824003825, 0.9264667954432715, 0.9097177310213524, 0.9346442091094386, 0.9203083819563623, 0.9401635985262097, 0.9349213581508373, 0.9458897741902882, 0.9353451090447322, 0.964989678872764, 0.9634099730196004, 0.9701656928428026, 0.9686572579366843, 0.974069907386716, 0.9708396316260214, 0.9753447859629438, 0.9726037618955405, 0.9766326639300998, 0.9740158115499955, 0.9779189399577168, 0.9754234616758197, 0.9789669113679258, 0.9765868636964733, 0.9799536264857678, 0.9779706795387256, 0.9809020140109214, 0.9788891348258091, 0.9816084737914827, 0.9797343518427208, 0.9822502742748633, 0.9710354228204524, 0.9382202626915205, 0.9457005540596318, 0.9512587524191554, 0.9435727750700562, 0.9500730615174079, 0.954629838657609, 0.9573368607795035, 0.9576336180945146, 0.9533286737306728, 0.9574656306522278, 0.9606964270024043, 0.9448332619034078, 0.951915957832326, 0.9565527341540118, 0.9599410708710203, 0.9626472692866624, 0.9646791721103257, 0.9679665362762234]

    kobayashi_keys = ["Hf2", "Hf3", "Ta2", "Ta3", "Ta4", "W0a", "W0b", "W0c", "W1a", "W1b", "W2c", "W3", "W4", "W5", "Re0a", "Re0b", "Re0c", "Re1a", "Re1b", "Re2", "Re3", "Re4", "Re5", "Re6", "Os0a", "Os0b", "Os0c", "Os1a", "Os1b", "Os2", "Os3", "Os4", "Os5", "Os6", "Os7", "Ir0a", "Ir0b", "Ir0c", "Ir1a", "Ir1b", "Ir2", "Ir3", "Ir4", "Ir5", "Ir6", "Pt1", "Pt2", "Pt3", "Pt4", "Pt5", "Pt6", "Au1", "Au2", "Au3", "Au4", "Au5"]
    kobayashi_refs = [0.8689440651253271, 0.8888136177131588, 0.8840686215950699, 0.8994004337496564, 0.9101528391610143, 0.8472388078049689, 0.8650067638665045, 0.879267908902524, 0.8779398246381942, 0.8880602665398635, 0.896093849382087, 0.9084055597571624, 0.9174422350375753, 0.9244679050355514, 0.8681630254808739, 0.8822371232551307, 0.8933169474106295, 0.8915297871341744, 0.8998453622986089, 0.9060230528912959, 0.9161468433220479, 0.9237747655215364, 0.9296393376164646, 0.9345562156909509, 0.8841187378321346, 0.8954374822984409, 0.904413051738971, 0.9025244946804027, 0.9094578103795641, 0.9143596889560148, 0.9228623215928715, 0.9293869806624924, 0.9345241242095418, 0.9387633528752165, 0.9423464867717495, 0.896643858631712, 0.9061310241612465, 0.9135576034496984, 0.9117017027338759, 0.9174776840032718, 0.9214765103783157, 0.9286788274192451, 0.9342761922806214, 0.9387216006635983, 0.9425685778782177, 0.9192223249722434, 0.9275720974747921, 0.9337847095781193, 0.9386221417937619, 0.9426937750124552, 0.9460141761165295, 0.9301232355721594, 0.9328984199721937, 0.9384038365877813, 0.9425634681355087, 0.9461716107116591]

    for (ref, key) in zip(brown_refs, brown_keys)
        @test ref ≈ Sunny.compute_form_factor(FormFactor(key; g_lande), q2)
    end

    for (ref, key) in zip(kobayashi_refs, kobayashi_keys)
        @test ref ≈ Sunny.compute_form_factor(FormFactor(key; g_lande), q2)
    end

    # Check error messages

    @test_throws "Form factor requires species name" FormFactor("Fe")

    @test_throws """
        Disambiguate form factor according to electronic configuration:
            "Ir0a" -- 6s⁰5d⁹
            "Ir0b" -- 6s¹5d⁸
            "Ir0c" -- 6s²5d⁷
        """ FormFactor("Ir0")

    # Check length units

    units1 = Units(:meV, :angstrom)
    units2 = Units(:meV, :nm)
    x1 = Sunny.compute_form_factor(FormFactor("Sc0"; g_lande, units1.length), q2 * units1.angstrom^(-2))
    x2 = Sunny.compute_form_factor(FormFactor("Sc0"; g_lande, units2.length), q2 * units2.angstrom^(-2))
    @test isapprox(x1, x2; atol=1e-14)
end
